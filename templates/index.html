<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† ìŠ¤ì¦ê¶Œ í”Œë« ë¯¸í„°ì¹˜ ìŠ¤ìºë„ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        body { padding: 40px; background-color: #f8f9fa; }
        .container { max-width: 1200px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-toss { background-color: #3182f6; color: white; font-weight: bold; border: none; }
        .btn-toss:hover { background-color: #1b64da; color: white; }
        .btn-scan { background-color: #e64980; color: white; font-weight: bold; border: none; } /* í•‘í¬ìƒ‰ ë²„íŠ¼ */
        .btn-scan:hover { background-color: #c0396b; color: white; }
        .plus { color: #d20f2e; font-weight: bold; }
        .minus { color: #1763c8; font-weight: bold; }
        #loading { display: none; text-align: center; margin: 20px 0; }
        .chart-wrapper { margin-bottom: 50px; border: 1px solid #ddd; padding: 10px; border-radius: 10px; background: #fff; }
        #charts-container { display: none; margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 30px; }
        .control-panel { background-color: #f1f3f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 15px; }
        
        /* ì‹œê·¸ë„ ë±ƒì§€ ì• ë‹ˆë©”ì´ì…˜ */
        .signal-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container text-center">
    <h2 class="mb-4">ğŸš€ 15ë¶„ë´‰ ë¯¸í„°ì¹˜(Gap) í”Œë« ìŠ¤ìºë„ˆ</h2>
    
    <div class="control-panel">
        <div class="d-flex align-items-center">
            <label for="flatK" class="form-label me-2 mb-0 fw-bold">ì°¨íŠ¸ Kê°’:</label>
            <input type="number" id="flatK" class="form-control" value="7" min="5" style="width: 70px;">
        </div>
        
        <button id="runBtn" class="btn btn-toss" onclick="fetchStockData()">
            1. ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        </button>

        <button id="scanBtn" class="btn btn-scan" onclick="scanSignals()" disabled>
            2. âš¡ ê³µì¤‘ë¶€ì–‘ ì‹œê·¸ë„ ìŠ¤ìº”
        </button>
    </div>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2" id="loading-text">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <div class="table-responsive mt-3">
        <table class="table table-hover table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>í‹°ì»¤</th>
                    <th>ìƒíƒœ (Signal)</th> <th>ì¢…ëª©ëª…</th>
                    <th>í˜„ì¬ê°€</th>
                    <th>ë“±ë½ë¥ </th>
                    <th>ì‹œê°€ì´ì•¡</th>
                    <th>ì°¨íŠ¸</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                <tr><td colspan="8" class="text-muted py-4">ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>

    <div id="charts-container">
        <h3 id="chart-title" class="mb-4"></h3>
        <div id="chart-area"></div>
    </div>
</div>

<script>
    let currentTickers = []; // í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì˜ í‹°ì»¤ë“¤ ì €ì¥ìš©

    // 1. ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    async function fetchStockData() {
        const btn = document.getElementById('runBtn');
        const scanBtn = document.getElementById('scanBtn');
        const loading = document.getElementById('loading');
        const tbody = document.getElementById('resultBody');

        btn.disabled = true;
        loading.style.display = 'block';
        document.getElementById('loading-text').innerText = "í† ìŠ¤ì¦ê¶Œ ë¦¬ìŠ¤íŠ¸ ìˆ˜ì§‘ ì¤‘...";
        
        // [ì¤‘ìš”] í…Œì´ë¸” ë° ë°ì´í„° ì´ˆê¸°í™”
        tbody.innerHTML = ''; 
        currentTickers = [];
        const seenTickers = new Set(); // ì¤‘ë³µ ë°©ì§€ìš© Set

        try {
            const response = await fetch('/api/scrape');
            const data = await response.json();

            if (data.error || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8">ë°ì´í„° ì—†ìŒ ë˜ëŠ” ì—ëŸ¬</td></tr>`;
                return;
            }

            let html = '';
            data.forEach(item => {
                // [ìˆ˜ì • 1] ì¤‘ë³µ í‹°ì»¤ í•„í„°ë§ (ì´ë¯¸ ë¦¬ìŠ¤íŠ¸ì— ìˆìœ¼ë©´ ê±´ë„ˆëœ€)
                if (seenTickers.has(item.ticker)) return;
                seenTickers.add(item.ticker);
                currentTickers.push(item.ticker);
                
                const colorClass = item.change_rate > 0 ? 'plus' : (item.change_rate < 0 ? 'minus' : '');
                const sign = item.change_rate > 0 ? '+' : '';
                
                html += `
                    <tr id="row-${item.ticker}" class="stock-row"> <td><strong>${item.rank}</strong></td>
                        <td><span class="badge bg-secondary">${item.ticker}</span></td>
                        <td class="signal-cell" id="signal-${item.ticker}">-</td> <td class="text-start">${item.name}</td>
                        <td>$${item.price.toFixed(4)}</td>
                        <td class="${colorClass}">${sign}${item.change_rate.toFixed(2)}%</td>
                        <td>${item.market_cap}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="fetchHistory('${item.ticker}')">
                                ğŸ“ˆ ì¡°íšŒ
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
            scanBtn.disabled = false;

        } catch (error) {
            console.error(error);
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    // 2. ì‹œê·¸ë„ ìŠ¤ìº” (ë°±ì—”ë“œ í˜¸ì¶œ)
    async function scanSignals() {
        const scanBtn = document.getElementById('scanBtn');
        const loading = document.getElementById('loading');
        
        if (currentTickers.length === 0) return;

        // [ìˆ˜ì • 2] ê¸°ì¡´ ì‹œê·¸ë„ ì‹¹ ì§€ìš°ê¸° (ì´ˆê¸°í™”)
        // ë²„íŠ¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ì´ì „ ê²°ê³¼ê°€ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡ ë¦¬ì…‹í•©ë‹ˆë‹¤.
        document.querySelectorAll('.stock-row').forEach(row => {
            row.style.backgroundColor = ''; // ë°°ê²½ìƒ‰ ì œê±°
            row.style.border = '';          // í…Œë‘ë¦¬ ì œê±°
        });
        document.querySelectorAll('.signal-cell').forEach(cell => {
            cell.innerHTML = '-';           // ë±ƒì§€ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        });

        scanBtn.disabled = true;
        loading.style.display = 'block';
        document.getElementById('loading-text').innerText = `ìƒìœ„ ${currentTickers.length}ê°œ ì¢…ëª© 15ë¶„ë´‰ ì •ë°€ ë¶„ì„ ì¤‘...`;

        try {
            const response = await fetch('/api/scan/signals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tickers: currentTickers })
            });
            const signals = await response.json();

            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            let count = 0;
            for (const [ticker, info] of Object.entries(signals)) {
                // í‹°ì»¤ì— ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ìê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                const cleanTicker = ticker.trim(); 
                const row = document.getElementById(`row-${cleanTicker}`);
                
                if (row) {
                    const signalCell = row.querySelector('.signal-cell');
                    
                    // ë§¤ìˆ˜ íƒ€ì  í‘œì‹œ
                    signalCell.innerHTML = `
                        <span class="badge bg-danger signal-badge mb-1">ğŸš¨ ë§¤ìˆ˜ëŒ€ê¸°</span><br>
                        <strong style="color: #d20f2e; font-size: 13px;">$${info.flat_price.toFixed(4)}</strong><br>
                        <span style="font-size:11px; color:#868e96;">(Gap: +${info.gap_pct}%)</span>
                    `;
                    
                    // í–‰ ê°•ì¡°
                    row.style.backgroundColor = "#fff5f5";
                    row.style.border = "2px solid #ffc9c9";
                    count++;
                }
            }
            
            if (count === 0) {
                alert("ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
            } else {
                alert(`${count}ê°œì˜ ì¢…ëª© ë°œê²¬!`);
            }

        } catch (error) {
            console.error(error);
            alert("ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        } finally {
            scanBtn.disabled = false;
            loading.style.display = 'none';
        }
    }

    // 3. ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    async function fetchHistory(ticker) {
        // [ì—¬ê¸°ì— ê¸°ì¡´ fetchHistory í•¨ìˆ˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤]
        // ... (ìƒëµ) ...
        // ë‹¨, ê¸°ì¡´ ì½”ë“œì—ì„œ chartContainer, chartArea ë³€ìˆ˜ ì„ ì–¸ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        // ì•„ë˜ëŠ” ì‹¤í–‰ì„ ìœ„í•œ ê»ë°ê¸°ì…ë‹ˆë‹¤. ê¸°ì¡´ ë¡œì§ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        
        const kInput = document.getElementById('flatK').value;
        const K = parseInt(kInput) || 7;

        const loading = document.getElementById('loading');
        const chartContainer = document.getElementById('charts-container');
        const chartArea = document.getElementById('chart-area');
        const chartTitle = document.getElementById('chart-title');
        
        document.getElementById('loading-text').innerText = "ì°¨íŠ¸ ë°ì´í„° ë¡œë”© ì¤‘...";
        loading.style.display = 'block';
        chartContainer.style.display = 'none';
        chartArea.innerHTML = '';

        try {
            const response = await fetch(`/api/history/${ticker}`);
            const data = await response.json();
            
            if (!data || data.length === 0) { alert("ë°ì´í„° ì—†ìŒ"); return; }

            chartTitle.innerText = `ğŸ“Š [${ticker}] ìƒì„¸ ë¶„ì„ (K=${K})`;
            chartContainer.style.display = 'block';

            data.forEach((chartData, index) => {
                const div = document.createElement('div');
                div.id = `chart-${index}`;
                div.className = 'chart-wrapper';
                chartArea.appendChild(div);
                
                // ... (ì°¨íŠ¸ ê·¸ë¦¬ê¸° ë¡œì§ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©) ...
                // ì´ì „ ë‹µë³€ì˜ shapes ë¡œì§ ë° Plotly.newPlot ë¶€ë¶„ ìœ ì§€
                 const spanB = chartData.span_b;
                 const dates = chartData.dates;
                 const shapes = [];
                 let currentRun = 1;
                 let startIndex = 0;
                 for (let i = 1; i < spanB.length; i++) {
                     const prev = spanB[i-1]; const curr = spanB[i];
                     if (curr !== null && curr === prev) { currentRun++; } 
                     else {
                         if (currentRun >= K && prev !== null) {
                             shapes.push({ type: 'line', xref: 'x', x0: dates[startIndex], x1: dates[i - 1], y0: prev, y1: prev, line: { color: 'purple', width: 3 }, opacity: 0.7 });
                         }
                         currentRun = 1; startIndex = i;
                     }
                 }
                 if (currentRun >= K && spanB[spanB.length-1] !== null) {
                    shapes.push({ type: 'line', xref: 'x', x0: dates[startIndex], x1: dates[dates.length - 1], y0: spanB[spanB.length-1], y1: spanB[spanB.length-1], line: { color: 'purple', width: 3 }, opacity: 0.7 });
                 }

                 const traceCandle = { x: chartData.dates, open: chartData.open, high: chartData.high, low: chartData.low, close: chartData.close, decreasing: {line: {color: 'blue'}}, increasing: {line: {color: 'red'}}, type: 'candlestick', name: 'Price' };
                 const traceSpanA = { x: chartData.dates, y: chartData.span_a, type: 'scatter', mode: 'lines', line: { width: 1, color: 'rgba(0, 150, 0, 0.5)' }, name: 'ì„ í–‰1' };
                 const traceSpanB = { x: chartData.dates, y: chartData.span_b, type: 'scatter', mode: 'lines', line: { width: 1, color: 'rgba(150, 0, 0, 0.5)' }, fill: 'tonexty', fillcolor: 'rgba(128, 128, 128, 0.2)', name: 'ì„ í–‰2' };

                 const layout = { title: chartData.title, dragmode: 'pan', showlegend: true, xaxis: { type: 'category', rangeslider: { visible: false }, nticks: 6, tickangle: -45 }, yaxis: { autorange: true, fixedrange: false }, height: 500, margin: { t: 50, b: 50, l: 50, r: 50 }, shapes: shapes };
                 Plotly.newPlot(div.id, [traceSpanA, traceSpanB, traceCandle], layout);
            });
            chartContainer.scrollIntoView({ behavior: 'smooth' });
        } catch (e) { console.error(e); } finally { loading.style.display = 'none'; }
    }
</script>

</body>
</html>